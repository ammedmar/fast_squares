%!TEX root = ../fast_sq.tex

\section{New algorithm for Steenrod squares} \label{s:algorithm}

%Throughout this section we use $\Delta_i$ to denote the $i^\th$ map introduced in \cref{d:cup-i coproducts}.

For a finite simplicial complex $X$ and a cocycle $\alpha$ we now present an algorithm effectively constructing a cocycle representing $Sq^k([\alpha])$.

Let $-n$ be the degree of $\alpha$ and let $A = \{a_1, \dots, a_m\} \subseteq X_n$ be its support.
Explicitly, if $\alpha_1 + \cdots + \alpha_m$ is the basis representation of $\alpha$ then
\begin{equation*}
\alpha_i(a_j) = \begin{cases}
1 & i=j, \\ 0 & i\neq j.
\end{cases}
\end{equation*}
If $k < 0$ or $k > n$, we have by definition that $Sq^k([\alpha]) = 0$ and we can take $0$ as its representative.
If $k = 0$, \cref{ex:Sq0 is the identity} shows that $Sq^0([\alpha]) = [\alpha]$ so we can take $\alpha$ as its representative.
For $k \in \{1, \dots, n\}$ \cref{a:algorithm} constructs a set $B \subseteq X_{n+k}$ such that if $\beta = (\alpha \otimes \alpha)\Delta_{n-k}(-)$, where $\Delta_{n-k}(-)$ is presented in \cref{d:cup-i coproducts}, we have
\begin{equation} \label{e:correctness}
\beta(x) =
\begin{cases}
1 & x \in B, \\
0 & x \not\in B,
\end{cases}
\end{equation}
for any simplex $x \in X_{n+k}$.
In other words, $B$ is the support of a cocycle representative of $Sq^k([\alpha])$.

\begin{figure}
	\input{aux/stsq}
	\caption{Algorithm producing for a simplicial complex $X$, non-negative integer $n$, integer $k$ between $1$ and $n$, and cocycle $\alpha$ presented as a set $A \subseteq X_n$, a cocycle representing $Sq^k([\alpha])$ returned as a set $B \subseteq X_{n+k}$.
	We use the notation $S \xor S^\prime = S \cup S^\prime \setminus (S \cap S^\prime)$ and $\ind(S) = \{\ind(v) \mid v \in S\}$.}
	\label{f:algorithm}
\end{figure}

\subsection{Correctness}

Before verifying \eqref{e:correctness}, let us record a property satisfied by our cup-$i$ construction that can be thought of as a form of ``freeness".

\begin{lemma} \label{l:freeness}
	Let $\gamma_1 + \dots + \gamma_m$ be the basis representation of a cochain in $C^{-n}(X; \Ftwo)$.
	Consider $i, j \in \{1, \dots, m\}$ with $i \neq j$ and $x \in X_{n+k}$.
	Let $\Delta_{n-k}$ be as introduced in \cref{d:cup-i coproducts}.
	\begin{enumerate}
		\item If $k \neq 0$ then $(\gamma_i \otimes \gamma_i)\Delta_{n-k}(x) = 0$.
		\item If $(\gamma_i \otimes \gamma_j)\Delta_{n-k}(x) \neq 0$ then $(\gamma_j \otimes \gamma_i)\Delta_{n-k}(x) = 0$.
	\end{enumerate}
\end{lemma}

\begin{proof}
	Recall that
	\begin{equation*}
	\Delta_{n-k}(x) \ = \! \sum_{\substack{U \subseteq \{0, \dots, n+k\} \\ \vert U \vert = 2k}}
	d_{U^0}(x) \otimes d_{U^1}(x).
	\end{equation*}

	(1) If $(\gamma_i \otimes \gamma_i)\Delta_{n-k}(x) \neq 0$, then there exists a non-empty $U$ in the sum with $U^0 = U^1$, which is impossible since $U^0 \cap U^1 = \emptyset$.

	(2) If $(\gamma_i \otimes \gamma_j)\Delta_{n-k}(x) \neq 0$ and $(\gamma_j \otimes \gamma_i)\Delta_{n-k}(x) \neq 0$, then there are distinct subsets $V$ and $W$ in the sum such that $V^0 = W^1$ and $W^0 = V^1$.
	But then $V = V^0 \cup V^1 = W^1 \cup W^0 = W$, which is a contradiction.
\end{proof}

Let us now return to the correctness of the algorithm.
For any $x \in X_{n+k}$ the value of $\beta$ evaluated on the chain represented by $x$ is given by
\begin{align*}
\beta(x) & =
(\alpha \otimes \alpha) \Delta_{n-k}(x) \\ & =
(\alpha_1 + \cdots + \alpha_m)^{\otimes 2} \Delta_{n-k}(x) \\ & =
\Big(\sum_{i \neq j} \alpha_i \otimes \alpha_j + \sum_{i} \alpha_i \otimes \alpha_i \Big)
\Delta_{n-k}(x) \\ & =
\Big(\sum_{i \neq j} \alpha_i \otimes \alpha_j\Big)
\Delta_{n-k}(x).
\end{align*}
By \cref{l:freeness}, at most one of the terms $\alpha_i \otimes \alpha_j$ or $\alpha_j \otimes \alpha_i$ evaluates to $1$ on $\Delta_{n-k}(x)$, so to determine the value of $\beta(x)$ we need to count mod 2 the number of subsets $\{i,j\} \subseteq \{1,\dots, m\}$ such that $\{a_i, a_j\} = \{d_{U^0}(x), d_{U^1}(x)\}$ for some $U \subseteq \{0, \dots, n+k\}$ of cardinality $2k$.
This condition on the pair $\{a_i, a_j\}$ implies in particular that $a_i \cup a_j = x$ since $d_{U^0}(x) \cup d_{U^1}(x) = x$.

Let us formalize these observations.
Let $\widetilde{A}$ be the set of all two-element subsets $\{a_i, a_j\} \subseteq A$ with $a_i \cup a_j \in X_{n+k}$.
There is a natural map $\pi \colon \widetilde{A} \to X_{n+k}$ sending $\{a_i, a_j\}$ to $a_i \cup a_j$.
Let $\eval \colon A \to \Ftwo$ be the map sending $\{a_i, a_j\}$ to $1$ if there exist $U \subseteq \{0, \dots, n+k\}$ of cardinality $2k$ such that $\{a_i, a_j\} = \{d_{U^0}(x), d_{U^1}(x)\}$ and let $\eval(\{a_i, a_j\}) = 0$ otherwise.
Notice that if such $U$ exists then it is unique.
With this notation we have
\begin{equation*}
\beta(x) \ = \! \sum_{\{a_i, a_j\} \in \pi^{-1}(x)} \! \eval(\{a_i, a_j\}).
\end{equation*}
We will give a computational characterization of $\eval(\{a_i, a_j\}) = 1$ after introducing some more notation.

Given a finite totally ordered set $S$, the \textit{position function} $\pos_S \colon S \to \Z$ sends an element $s \in S$ to the cardinality of $\{s^\prime \in S \mid s^\prime \leq s\}$.
For any $S^\prime \subseteq S$ we write
\[
\pos_{S} \big( S^\prime \big) =
\{\pos_{S} (s^\prime) \mid s^\prime \in S^\prime\}.
\]

Consider $\{a_i, a_j\} \in \pi^{-1}(x)$, two distinct simplices whose union of simplices $a_{ij} = a_i \cup a_j$ equal to $x$.
Let $(\ast)$ be the statement that there exist $U \subseteq \{0, \dots, n+k\}$ with $\{a_i, a_j\} = \{d_{U^0}(x),\, d_{U^1}(x)\}$.
Notice that is such $U$ exists then it is unique.
We will now describe a condition equivalent to $(\ast)$ in terms of $\{a_i, a_j\}$ only.
Denote
\begin{equation*}
\overline{a}_{i} = a_i \setminus a_j, \qquad
\overline{a}_{j} = a_j \setminus a_i, \qquad
\overline{a}_{ij} = \overline{a}_i \cup \overline{a}_j.
\end{equation*}
A necessary condition for $(\ast)$ is that $\pos_{a_{ij}} \colon \overline{a}_{ij} \to \Z$ is an isomorphism onto $U$.
Slightly abusing notation we define the function $\ind \colon \overline{a}_{ij} \to \Ftwo$ by
\begin{equation*}
\ind(v) = \pos_{a_{ij}}(v) + \pos_{\overline{a}_{ij}}(v) \text{ mod }2
\end{equation*}
and notice that it fits in the commutative diagram
\[
\begin{tikzcd}[column sep=small, row sep=small]
\overline{a}_{ij} \arrow[rr, "\pos_{a_{ij}}", "\cong"'] \arrow[dr, "\ind"', bend right] & &
U \arrow[dl, "\ind_U", bend left] \\
& \Ftwo &
\end{tikzcd}
\]
where $\ind_U$ was introduced in \cref{d:index function}.
Since for $\varepsilon \in \Ftwo \cong \{0,1\}$ we have $U^\varepsilon = \ind_U^{-1}(\varepsilon)$, condition $(\ast)$ is equivalent to the existence of $U$ with
\begin{equation} \label{e:pos's equal U's}
\big\{\pos_{a_{ij}}(\overline{a}_i),\, \pos_{a_{ij}}(\overline{a}_j)\big\} = \{U^0, U^1\}.
\end{equation}
Or, equivalently, that the function $\ind \colon \overline{a}_{ij} \to \Ftwo$ is constant on both $\overline{a}_i$ and $\overline{a}_j$ with different values, i.e.,
\begin{equation*}
\ind(\overline{a}_i) \xor \ind(\overline{a}_j) = \{0,1\},
\end{equation*}
where $\ind(S) = \{\ind(v) \mid v \in S\}$ for any $S \subseteq \overline{a}_{ij}$.

Therefore, for any $x \in X_{n+k}$ we have $\beta(x) = 1$ if and only if the set of pairs $\{a_i, a_j\}$ in $\pi^{-1}(x)$ with $\eval(\{a_i, a_j\}) = 1$ is odd; which is equivalent to the condition $x \in B$.

\subsection{Advantages}

Consider a simplicial complex $X$, an cocycle $\alpha$ of degree $-n$, and a cup-$i$ construction
\[
\Delta_i(x) =
\sum_{\Gamma_i} x^{(1)} \otimes x^{(2)}.
\]
An algorithm for the computation of a representative of the $k^\th$ Steenrod square of the class $[\alpha]$ for $k \in \{1, \dots, n\}$ would loop over simplices $X_{n+k}$ and over $\Gamma_{n-k}$ evaluating $(\alpha \otimes \alpha)$ on the associated tensor pair.
\cref{a:algorithm} improves on this scheme by not summing over $X_{n+k}$ times $\Gamma_{n-k}$, but filtering summands using the support of $\alpha$.
So, even if $X_{n+k}$ and $\Gamma_{n-k}$ are very large, \cref{a:algorithm} considers at most
\[
\frac{\bars{A} \big( \bars{A}-1 \big)}{2}
\]
summands, where $\bars{A}$ is the cardinality of the support of $\alpha$.